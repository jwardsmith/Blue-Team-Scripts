Part 1: Acquire, Preserve, Document Evidence

Static Analysis:

- Consider and examine the following:
  - What is the file type?
    - Relying on file extension is not the sole indicator of file type. In some cases, you will need to look for the file signature of the file by opening it in a hex editor, using the Detect File Type recipe in CyberChef, or using the file command in Linux.
  - What is the name of the file?
    - Look for subtle misspellings or legitimate process names that shouldn't necessarily be running on the system you are analysing. Search for the file name using a search engine like Google.
  - What is the full path of the file?
    - Check if this is the appropriate path for the file to be located. You can generally use a search engine like Google to find this information, or you can check EchoTrail.
    - Common malware locations: \Temp, \AppData, \$Recycle.Bin, \ProgramData, \Windows, \Windows\System32, \WinSxS, \System Volume Information, \Program Files, \Program Files (x86).
    - Use file paths to establish context and permissions. Malware in a protected directory such as C:\Windows means local administrator rights, whereas malware in the C:\Users<USERNAME>\AppData\Roaming directory indicates user level compromise.
    - Use folder locations to provide context on the delivery method of malware. Is the file in a temporary directory, a cache directory or a user's download folder? Malware in a short path to the C:\ drive accompanied by many other suspicious executables can indicate presence of a hands-on keyboard threat actor.
  - What is the parent process of the file?
    - Is the parent process what you would expect? You can generally use a search engine like Google to find this information, or you can check EchoTrail. A malicious parent process can spawn a legitimate child process, and a legitimate parent process can spawn a malicious child process. Check all grandparent and grandchild processes.
    - Use the parent process to provide context of the delivery method of malware. Is the parent process IIS and the child process cmd.exe indicating webshell behaviour or is the parent process Word and the child process powershell.exe indicating a malicious macro.
  - What is the command line of the file if applicable?
    - Are there any strange arguments or long strings that the process is using?
    - Does the command line of the file include base64 encoding?
  - Where did the file originate from?
    - Did the file come from a web download, an email, an external storage device such as a USB?
  - Has the file been allowed to execute?
    - Did the file get quarantined? A file getting quarantined does not mean the file is definitely malicious, and may be the result of an incorrect signature.

Gather the scope:
  - Is the file observed on any other device in the organisation or worldwide? How many?
  - What is the priority of the device(s) the file has been observed on?
    - A suspicious file on a Domain Controller or other critical priority asset warrants immediate action.
  - What is the priority of the user(s) associated with the device the file has been observed on?
    - A suspicious file that is associated with a highly-privileged user such as a Domain Admin warrants immediate action.
   
Retrieve or calculate the hash of the file:
  - There are various ways to do this such as EDR, Sysmon, etc...

Check the reputation of the hash of the file:
  - Search the hash of the file in VirusTotal, and consider and examine the following:
    - DETECTION TAB:
      - How many vendors are classifying the hash as malicious? Use this as guidance only - 1 or 2 detections does NOT mean the file is definitely malicious, and 0 detections does NOT mean the file is definitely not malicious.
      - What is the reputation of the vendors classifying the hash as malicious? Vendors with a high reputation include CrowdStrike Falcon, Fortinet, Google, Kaspersky, McAfee, Microsoft, PaloAlto Networks, SentinelOne, Sophos, and Symantec.
    - DETAILS TAB:
      - What type of file has the hash been detected as? Does it match up with your own analysis?
      - What other names has the file been observed as?
      - Does the file have a digital signature?
    - RELATIONS TAB:
      - Are there any malicious IOC's the hash of the file has a relationship with?
    - BEHAVIOR TAB:
      - Does the file exhibit any suspicious behaviour? Pay attention to Sigma rules the file has triggered, what IOC's it communicates with (not just IP addresses), what files it drops, whatregistry keys it touches, and what processes it starts.
    - COMMUNITY TAB:
      - What is the community saying about the hash of the file?
     
Check if the file has a digital signature:
  - According to McAfee labs 2019 Threat Report, much less than 3% of all malware is signed. Nation-state actors have a higher percentage of signed code, so do not ignore signed code, but it can be a good indicator if a file is malicious or legitimate.
  - Check the signer of the file if you have it saved locally using Sigcheck:
    - .\sigcheck.exe .\<FILE NAME>

Extract the strings from a file:
  - Open the file if you have it saved locally in Notepad++ text editor if the file is a script or other readable file.
    - Look for obfuscated code, base64 encoding, strings that reference external IP's or URL's, strange variable names.
      - Extract the strings from a file if you have it saved locally using bstrings.
        - .\bstrings.exe -f .\<FILE NAME>
      - Extract the strings from a file if you have it saved locally using PEStudio.
        - Look for any strings that would provide information or context as to the capabilities of the file.
       
OPTIONAL: Consider checking the file in a disassembler such as IDA if you have the ability to read andunderstand assembly. If not, escalate to a senior SOC analyst.

Dynamic Analysis:

Check sandbox for any existing reports of the file hash:
  - Search the hash of the file in Hybrid Analysis, and consider and examine the following:
    - What is the Threat Score percentage and AV Detection percentage?
    - What tags are associated with the file hash?
    - What malicious indicators were identified?
    - What suspicious indicators were identified?
    - Does the file communicate with any external addresses?
 
Retrieve a sample of the file if necessary:
  - There are various ways to do this such as EDR.

Submit the file to a sandbox if necessary:
  - Take care when submitting files to a public sandbox. Confidential files should NEVER be uploaded to a public sandbox. Uploading previously unseen malware that has been targeted only to 1 organisation to a sandbox may alert the threat actor that a security team are aware of their presence within an environment, and they may change their techniques, try to embed themselves in our environment before evicted or launch a full-fledged attack in response.

OPTIONAL: Consider checking the fle in a debugger such as winDbg if you have the ability to read and understand assembly. If not, escalate to a senior SOC analyst.
